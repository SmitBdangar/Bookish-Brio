{% extends "home/base.html" %}

{% block title %}Bookish Brio - Share Your Stories{% endblock %}

{% block content %}
<section class="posts-feed">
    {% if page_obj %}
    {% for post in page_obj %}
    <article class="post-card" onclick="window.location.href='{% url 'post_detail' post.pk %}'">
        <div class="post-main">
            <div class="post-meta">
                <a href="{% url 'public_profile' post.author.username %}" class="post-author"
                    onclick="event.stopPropagation();">
                    u/{{ post.author.username }}
                </a>
                <span>•</span>
                <span>{{ post.created_at|timesince }} ago</span>
                {% if post.reading_time %}
                <span>•</span>
                <span>{{ post.reading_time }}</span>
                {% endif %}
            </div>

            <h2 class="post-title">{{ post.title }}</h2>

            {% if post.image %}
            <div class="post-image"
                style="margin: -12px -12px 12px -12px; max-height: 512px; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                <img src="{{ post.image.url }}" alt="{{ post.title }}"
                    style="width: 100%; height: auto; display: block;">
            </div>
            {% endif %}

            <div class="post-content-preview"
                style="font-size: 0.95rem; color: #4a4a4a; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                {{ post.preview_content }}
            </div>
        </div>

        <div class="post-actions">
            <div class="engagement-item" style="display: flex; align-items: center; gap: 4px;">
                <form action="{% url 'like_post' post.pk %}" method="POST" class="like-form"
                    onclick="event.stopPropagation();">
                    {% csrf_token %}
                    <button type="submit" class="action-btn {% if user in post.likes.all %}active{% endif %}"
                        title="Like">
                        <i class="{% if user in post.likes.all %}fas{% else %}far{% endif %} fa-heart"></i>
                        <span class="count">{{ post.total_likes }}</span>
                    </button>
                </form>
            </div>

            <div class="engagement-item">
                <a href="{% url 'post_detail' post.pk %}" class="action-btn" onclick="event.stopPropagation();">
                    <i class="far fa-comment"></i>
                    <span>{{ post.comment_count }}</span>
                </a>
            </div>

            {% if user.is_authenticated %}
            <div class="engagement-item">
                <form action="{% url 'bookmark_post' post.pk %}" method="POST" class="bookmark-form"
                    onclick="event.stopPropagation();">
                    {% csrf_token %}
                    <button type="submit" class="action-btn {% if post.is_bookmarked %}active{% endif %}" title="Save">
                        <i class="{% if post.is_bookmarked %}fas{% else %}far{% endif %} fa-bookmark"></i>
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </article>
    {% endfor %}
    {% else %}
    <div
        style="background: white; padding: 60px; text-align: center; border-radius: 4px; border: 1px solid var(--border);">
        <i class="fas fa-feather fa-3x" style="margin-bottom: 16px; opacity: 0.1;"></i>
        <h3>No posts yet</h3>
        <p>Be the first to share a story!</p>
        <a href="{% url 'add_post' %}" class="btn-orange" style="margin-top: 20px;">Create Post</a>
    </div>
    {% endif %}

    {% if page_obj.has_other_pages %}
    <div class="pagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 24px;">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}" class="btn-orange"
            style="background: #f6f7f8; color: var(--text-main); font-size: 0.85rem;">Previous</a>
        {% endif %}
        <span
            style="padding: 8px 16px; background: white; border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem;">Page
            {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn-orange"
            style="background: #f6f7f8; color: var(--text-main); font-size: 0.85rem;">Next</a>
        {% endif %}
    </div>
    {% endif %}
</section>
{% endblock %}

{% block sidebar %}
<div class="sidebar-widget"
    style="background: white; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 16px; overflow: hidden;">
    <div style="background: var(--primary); color: white; padding: 12px; font-weight: 700; font-size: 0.9rem;">
        Trending Topics
    </div>
    <div style="padding: 12px;">
        {% if trending_tags %}
        <ul style="list-style: none;">
            {% for tag in trending_tags %}
            <li style="margin-bottom: 12px;">
                <a href="?q={{ tag.name }}"
                    style="text-decoration: none; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                    <span><i class="fas fa-hashtag" style="color: var(--primary); margin-right: 6px;"></i>{{ tag.name
                        }}</span>
                    <span style="color: var(--text-meta);">{{ tag.post_count }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p style="font-size: 0.85rem; color: var(--text-meta);">No tags found</p>
        {% endif %}
    </div>
</div>
{{ block.super }}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle Like AJAX
        document.querySelectorAll('.like-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const btn = this.querySelector('button');
                const icon = btn.querySelector('i');
                const countSpan = btn.querySelector('.count');

                fetch(this.action, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.liked) {
                            icon.className = 'fas fa-heart';
                            btn.classList.add('active');
                        } else {
                            icon.className = 'far fa-heart';
                            btn.classList.remove('active');
                        }
                        countSpan.textContent = data.total_likes;
                    });
            });
        });

        // Handle Bookmark AJAX
        document.querySelectorAll('.bookmark-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const btn = this.querySelector('button');
                const icon = btn.querySelector('i');

                fetch(this.action, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.bookmarked) {
                            icon.className = 'fas fa-bookmark';
                            btn.classList.add('active');
                        } else {
                            icon.className = 'far fa-bookmark';
                            btn.classList.remove('active');
                        }
                    });
            });
        });
    });
</script>
{% endblock %}