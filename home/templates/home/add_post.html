{% extends "home/base.html" %}

{% block title %}Create Post - Bookish Brio{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .composition-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 32px;
        box-shadow: var(--shadow-soft);
    }

    .form-title {
        font-family: 'Outfit', sans-serif;
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 24px;
        color: var(--text-main);
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text-main);
    }

    .form-group input[type="text"] {
        width: 100%;
        padding: 14px 16px;
        border: 1.5px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        background: hsl(210, 15%, 98%);
        transition: var(--transition);
        outline: none;
    }

    .form-group input[type="text"]:focus {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 4px hsla(16, 100%, 50%, 0.1);
    }

    #editor-container {
        min-height: 350px;
        border-radius: 0 0 12px 12px;
        border: 1.5px solid var(--border);
        border-top: none;
        font-family: 'Inter', sans-serif;
        font-size: 1rem;
    }

    .ql-toolbar.ql-snow {
        border-color: var(--border);
        border-width: 1.5px;
        border-radius: 12px 12px 0 0;
        background: hsl(210, 15%, 98%);
        padding: 12px;
    }

    .file-drop-area {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 32px 24px;
        text-align: center;
        background: hsl(210, 15%, 98%);
        cursor: pointer;
        transition: var(--transition);
    }

    .file-drop-area:hover {
        border-color: var(--primary);
        background: white;
    }

    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }

    .preview-item {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        border: 1.5px solid var(--border);
        box-shadow: var(--shadow-soft);
    }

    .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remove-img {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .remove-img:hover {
        background: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="composition-card">
    <h1 class="form-title">Create a Post</h1>

    <form method="post" enctype="multipart/form-data" id="postForm">
        {% csrf_token %}

        <div class="form-group">
            <label>Title</label>
            {{ form.title }}
        </div>

        <div class="form-group">
            <label>Content</label>
            <div id="editor-container"></div>
            <div style="display:none;">{{ form.content }}</div>
        </div>

        <div class="form-group">
            <label>Tags (separate with commas)</label>
            {{ form.tags_input }}
        </div>

        <div class="form-group">
            <label>Add Image</label>
            <div class="file-drop-area" id="dropArea">
                <i class="fas fa-cloud-upload-alt fa-3x"
                    style="color: var(--primary); margin-bottom: 12px; opacity: 0.8;"></i>
                <p style="font-size: 1rem; color: var(--text-main); font-weight: 600;">Drag and drop or click to upload
                </p>
                <p style="font-size: 0.85rem; color: var(--text-meta); margin-top: 4px;">PNG, JPG, GIF up to 10MB</p>
                <input type="file" name="images" id="imageInput" multiple accept="image/*" style="display:none;">
            </div>
            <div class="preview-grid" id="previewGrid"></div>
        </div>

        <div
            style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 32px; border-top: 1.5px solid var(--border); padding-top: 24px;">
            <a href="{% url 'index' %}" class="btn-orange"
                style="background: transparent; border: 1.5px solid var(--primary); color: var(--primary); box-shadow: none;">Cancel</a>
            <button type="submit" class="btn-orange">Post to Brio</button>
        </div>
    </form>
</div>
{% endblock %}

{% block sidebar %}
<div class="sidebar-widget">
    <div class="widget-title">Posting Guidelines</div>
    <div style="padding: 16px;">
        <ol style="font-size: 0.9rem; color: var(--text-main); padding-left: 20px; line-height: 1.8; font-weight: 500;">
            <li>Remember the human</li>
            <li>Behave like you would in real life</li>
            <li>Look for the original source of content</li>
            <li>Search for duplicates before posting</li>
            <li>Read the community's rules</li>
        </ol>
    </div>
</div>
{{ block.super }}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Quill Setup
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: 'Share your story with the community...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'blockquote', 'code-block'],
                    ['clean']
                ]
            }
        });

        const contentInput = document.querySelector('textarea[name="content"]');
        if (contentInput && contentInput.value) quill.root.innerHTML = contentInput.value;

        // Image Selection Logic
        const dropArea = document.getElementById('dropArea');
        const imageInput = document.getElementById('imageInput');
        const previewGrid = document.getElementById('previewGrid');
        let filesList = [];

        dropArea.addEventListener('click', () => imageInput.click());

        imageInput.addEventListener('change', function (e) {
            filesList = Array.from(this.files);
            updatePreview();
        });

        function updatePreview() {
            previewGrid.innerHTML = '';
            filesList.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `<img src="${e.target.result}"><div class="remove-img" data-idx="${idx}">Ã—</div>`;
                    previewGrid.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        previewGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-img')) {
                const idx = e.target.getAttribute('data-idx');
                filesList.splice(idx, 1);
                const dt = new DataTransfer();
                filesList.forEach(f => dt.items.add(f));
                imageInput.files = dt.files;
                updatePreview();
            }
        });

        // Form Submission
        document.getElementById('postForm').addEventListener('submit', function () {
            contentInput.value = quill.root.innerHTML;
        });

        // Add form-control class to input
        const titleInput = document.querySelector('input[name="title"]');
        if (titleInput) titleInput.placeholder = "Title your post";

        const tagsInput = document.querySelector('input[name="tags_input"]');
        if (tagsInput) {
            tagsInput.placeholder = "Add tags like: poetry, short-story, review";
            tagsInput.type = "text";
        }
    });
</script>
{% endblock %}